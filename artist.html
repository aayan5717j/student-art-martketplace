<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Artist Profile - Student Art Hub</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{margin:0;font-family:Arial;background:#f3f4f6}
header{background:#1e3a8a;color:#fff;padding:15px}
.container{max-width:1000px;margin:auto;padding:16px}
.profile,.box{background:#fff;padding:16px;border-radius:10px;margin-bottom:20px}
button{background:#1e3a8a;color:#fff;border:none;padding:10px 14px;border-radius:6px;cursor:pointer}
.small{font-size:13px;color:#555}
.rating{color:#f59e0b;font-weight:bold}
textarea,select{width:100%;padding:8px;margin-top:6px}
.modal{
  display:none;
  position:fixed;
  left:0;
  top:0;
  width:100%;
  height:100%;
  background:rgba(0,0,0,0.6);
  align-items:center;
  justify-content:center;
  z-index:999;
}

</style>
</head>

<body>

<header>
  <div class="container">
    <h2>üé® Student Art Hub</h2>
  </div>
</header>

<div class="container">

<!-- ===== ARTIST PROFILE ===== -->
<div class="profile">
  <h2 id="artistName">Artist</h2>
  <p class="small">Custom Sketch Artist</p>
  <p id="artistRating" class="rating">‚≠ê No ratings yet</p>
</div>

<!-- ===== REQUEST FORM ===== -->
<div class="box">
  <h3>Request a Custom Sketch ‚úçÔ∏è</h3>

  <label>Sketch Size</label>
  <select id="size">
    <option value="A4">A4 Sketch</option>
    <option value="A3">A3 Sketch</option>
  </select>

  <br><br>

  <label>Describe your sketch</label>
  <textarea id="details"
    placeholder="Portrait, pencil style, reference photo, delivery time, etc."
    rows="4"></textarea>

  <br><br>

  <button onclick="requestSketch()">Send Request</button>
</div>

</div>
<!-- ===== SELLER ORDERS (ARTIST ONLY) ===== -->
<div id="sellerOrdersBox" class="box" style="display:none">
  <h3>Incoming Orders üì¶</h3>
  <div id="sellerOrders"></div>
</div>
<!-- ===== BUYER RATING POPUP ===== -->
<div id="ratingModal" class="modal">
  <div class="box">
    <h3>Rate Artist ‚≠ê</h3>
    <p class="small">Please rate your experience</p>

    <div style="font-size:26px">
      <span onclick="rateArtist(1)">‚≠ê</span>
      <span onclick="rateArtist(2)">‚≠ê</span>
      <span onclick="rateArtist(3)">‚≠ê</span>
      <span onclick="rateArtist(4)">‚≠ê</span>
      <span onclick="rateArtist(5)">‚≠ê</span>
    </div>

    <br>
    <button onclick="closeRating()">Cancel</button>
  </div>
</div>


<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getAuth, onAuthStateChanged } 
from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

import { getDatabase, ref, get, onValue, push, set } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";
let currentOrderForRating = null;

/* ===== FIREBASE ===== */
const firebaseConfig={
  apiKey:"AIzaSyBxD8SLW9z8ndgAJprcGolqivlNUZVYZxc",
  authDomain:"art-hub-77eb1.firebaseapp.com",
  databaseURL:"https://art-hub-77eb1-default-rtdb.firebaseio.com",
  projectId:"art-hub-77eb1"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

/* ===== GET ARTIST ID ===== */
const params = new URLSearchParams(window.location.search);
const artistId = params.get("id");
if(!artistId){
  alert("Artist not found");
  throw new Error("No artist id");
}

/* ===== LOAD ARTIST INFO ===== */
get(ref(db,"users/"+artistId)).then(snap=>{
  const u = snap.val();
  if(u){
    document.getElementById("artistName").textContent = u.name || "Artist";
  }
});

/* ===== LOAD RATINGS ===== */
onValue(ref(db,"ratings/"+artistId),snap=>{
  const data = snap.val();
  if(!data) return;

  const arr = Object.values(data);
  const avg = (arr.reduce((s,r)=>s+r.stars,0)/arr.length).toFixed(1);

  document.getElementById("artistRating").textContent =
    `‚≠ê ${avg} (${arr.length} reviews)`;
});

/* ===== REQUEST SKETCH (MAIN LOGIC) ===== */
window.requestSketch = async () => {

  if(!auth.currentUser){
    alert("Please login first");
    return;
  }

  const size = document.getElementById("size").value;
  const details = document.getElementById("details").value.trim();

  if(!details){
    alert("Please describe your sketch");
    return;
  }

  // SAVE ORDER
  const r = push(ref(db,"customOrders"));
  await set(r,{
    id: r.key,
    buyerId: auth.currentUser.uid,
    artistId: artistId,
    size: size,
    details: details,
    status: "pending",
rated: false,
time: Date.now()

  });

  // OPEN WHATSAPP
  get(ref(db,"users/"+artistId)).then(snap=>{
    const s = snap.val();
    if(!s?.whatsapp){
      alert("Artist WhatsApp not available");
      return;
    }


    const msg = `Hello üëã
I want a custom sketch from Student Art Hub.

üé® Size: ${size}
üìù Details: ${details}

Please let me know next steps.`;

    window.open(
      `https://wa.me/${s.whatsapp}?text=${encodeURIComponent(msg)}`
    );
  });
};
/* ===== SHOW SELLER ORDERS (ARTIST ONLY) ===== */
onAuthStateChanged(auth, user => {
  if (user && user.uid === artistId) {
    document.getElementById("sellerOrdersBox").style.display = "block";

    onValue(ref(db,"customOrders"), snap => {
      const all = snap.val() || {};
      const my = Object.values(all).filter(o =>
        o.artistId === artistId && o.status === "pending"
      );

      const box = document.getElementById("sellerOrders");

      if (!my.length) {
        box.innerHTML = "<p class='small'>No pending orders</p>";
        return;
      }

      box.innerHTML = my.map(o => `
        <div class="profile">
          <p><b>Size:</b> ${o.size}</p>
          <p><b>Details:</b> ${o.details}</p>
          <button onclick="markCompleted('${o.id}')">
            Mark Completed
          </button>
        </div>
      `).join("");
    });
  }
});

window.markCompleted = async (orderId) => {
  await set(ref(db,"customOrders/"+orderId+"/status"),"completed");
  

  alert("Order marked as completed ‚úÖ");
};


/* ===== OPEN RATING POPUP (BUYER) ===== */
window.openRating = (orderId) => {
  // artist khud rate na kare
  if (auth.currentUser?.uid === artistId) return;

  currentOrderForRating = orderId;
  document.getElementById("ratingModal").style.display = "flex";
};


/* ===== CLOSE POPUP ===== */
window.closeRating = () => {
  document.getElementById("ratingModal").style.display = "none";
};

/* ===== SAVE RATING ===== */
window.rateArtist = async (stars) => {
  if (!auth.currentUser) return;

  const r = push(ref(db,"ratings/"+artistId));
  await set(r,{
    buyerId: auth.currentUser.uid,
    stars: stars,
    time: Date.now()
  });

  // mark order as rated
  await set(
    ref(db,"customOrders/"+currentOrderForRating+"/rated"),
    true
  );

  alert("Thanks for rating ‚≠ê");
  closeRating();
};

</script>

</body>
</html>
