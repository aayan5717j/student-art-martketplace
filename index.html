<!DOCTYPE html>
<html lang="en">

<head>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="description"
        content=" The Student Marketplace: Buy, sell, and exchange student-made art, books, sketches, and notes at affordable prices." />

  <meta name="keywords"
        content="student art, marketplace, buy sell art, custom sketches, handwritten notes, book exchange" />

  <title>The Student Marketplace
  </title>


  <!--  BASIC STYLES  -->
  <style>

      body {
        margin: 0;
        font-family: Arial;
        background: #f2f2f2;
      }

      header {
        background: #1e3a8a;
        color: #fff;
        padding: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      nav a {
        color: #fff;
        margin: 0 10px;
        text-decoration: none;
        font-weight: bold;
      }

      .container {
        padding: 20px;
      }

      .hero {
        background: #fff;
        padding: 30px;
        border-radius: 10px;
      }

      input,
      select,
      button,
      textarea {
        padding: 8px;
        margin: 5px;
        width: 100%;
        max-width: 350px;
      }

      button {
        cursor: pointer;
        background: #1e3a8a;
        color: #fff;
        border: none;
        border-radius: 5px;
      }

      /* ===== RESPONSIVE GRID ===== */
.grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
  gap: 16px;
}


      .card {
        background: #fff;
        padding: 15px;
        border-radius: 10px;
        
        text-align: center;
      }

      .card img {
        max-width: 100%;
        height: 150px;
        object-fit: cover;
        border-radius: 5px;
        margin-bottom: 10px;
      }

      footer {
        background: #111;
        color: #fff;
        text-align: center;
        padding: 15px;
        margin-top: 40px;
      }

      .loading {
        display: none;
        color: #666;
      }

      .tab {
        display: flex;
        margin-bottom: 10px;
      }

      .tab button {
        background: #ddd;
        border: none;
        padding: 10px;
        flex: 1;
        cursor: pointer;
      }

      .tab button.active {
        background: #1e3a8a;
        color: #fff;
      }

      .strength {
        color: red;
      }

      .strength.strong {
        color: green;
      }

      .user-menu {
        position: relative;
        display: none;
      }

      .menu-btn {
        font-size: 24px;
        background: none;
        border: none;
        color: #fff;
        cursor: pointer;
      }

      .dropdown {
        position: absolute;
        top: 40px;
        right: 0;
        background: #fff;
        border: 1px solid #ccc;
        border-radius: 5px;
        padding: 10px;
        display: none;
        z-index: 10;
      }

      .dropdown button {
        background: #f2f2f2;
        color: #000;
        border: 1px solid #ccc;
        margin: 5px 0;
        width: 100%;
      }

      .dashboard {
        background: #fff;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
      }

      .stats {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
      }

      .stat {
        background: #e0f7fa;
        padding: 15px;
        border-radius: 5px;
        width: 150px;
        text-align: center;
      }

      .actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin: 20px 0;
      }

      .recent {
        background: #fff;
        padding: 15px;
        border-radius: 5px;
        margin-top: 20px;
      }

      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 20;
        justify-content: center;
        align-items: center;
      }

      .modal-content {
        background: #fff;
        padding: 20px;
        border-radius: 10px;
        width: 300px;
        text-align: center;
      }

      @media (max-width: 600px) {
     
        .card { width: 100%; }
        header { flex-direction: column; align-items: flex-start; }
      }
/* ===== LOADER ===== */
.loader {
  width: 40px;
  height: 40px;
  border: 4px solid #ddd;
  border-top: 4px solid #1e3a8a;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: 30px auto;
  display: none;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
/* ===== SELLER DASHBOARD IMPROVEMENTS ===== */

.dashboard h3 {
  margin-bottom: 10px;
}

.actions button {
  background: #2563eb;
  padding: 10px 14px;
  border-radius: 8px;
  font-size: 14px;
}

.actions button:hover {
  opacity: 0.9;
}

#sellerPanel {
  background: #f9fafb;
  padding: 20px;
  border-radius: 12px;
  border: 1px solid #ddd;
}

#sellerPanel h4 {
  margin-bottom: 10px;
  color: #1e3a8a;
}
#myListings {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
}
/* Seller listing card look */
#myListings .card {
  background: #ffffff;
  border: 1px solid #ddd;
  border-radius: 10px;
  padding: 12px;
  text-align: center;
}

/* Title */
#myListings .card h4 {
  margin: 8px 0 4px;
  font-size: 15px;
}

/* Price */
#myListings .card p {
  margin: 0;
  font-size: 14px;
  color: #333;
}

/* Delete button */
#myListings .card button {
  background: #dc2626;
  color: #fff;
  margin-top: 8px;
  padding: 6px 10px;
  border-radius: 6px;
}

  </style>

</head>

<body>

<!-- ================= HEADER ================= -->
<header>

  <h2> The Student Marketplace</h2>

  <nav>
    <a href="index.html">Home</a>
    <a href="art.html">Art Showcase</a>
    <a href="books.html">Book Exchange</a>
    <a href="sketches.html">Custom Sketches</a>
    <a href="notes.html">Handwritten Notes</a>
    <a href="donations.html">Donations</a>
  </nav>

  <div id="userMenu" class="user-menu">
    <button id="menuBtn" class="menu-btn">â‹®</button>

    <div id="dropdown" class="dropdown">
      <button id="logoutBtn">Logout</button>
    </div>
  </div>

</header>



<!-- ================= MAIN CONTAINER ================= -->
<div class="container">


<!-- ================= HERO ================= -->
<section class="hero">
  <h2>Buy â€¢ Sell â€¢ Exchange â€” Student-made</h2>
  <p>Artworks, books, sketches & handwritten notes</p>

  <input id="searchBar" placeholder="Search..." />
  <button id="searchBtn">Search</button>
</section>



<!-- ================= AUTH SECTION ================= -->
<section id="authSection">

  <h3>Login / Signup</h3>

  <!-- Tabs -->
  <div class="tab">
    <button id="emailTab" class="active">Email</button>
    <!-- <button id="phoneTab">Phone OTP</button> -->
  </div>


  <!-- EMAIL AUTH -->
  <div id="emailAuth">

    <input id="email" type="email" placeholder="Email">
    <input id="password" type="password" placeholder="Password">

    <div id="passwordStrength" class="strength"></div>

    <select id="role">
      <option value="buyer">Buyer</option>
      <option value="seller">Seller</option>
    </select>

    <input id="whatsapp"
           type="tel"
           placeholder="WhatsApp Number"
           style="display:none;">

    <label>
      <input id="rememberMe" type="checkbox"> Remember Me
    </label>

    <button id="signupBtn">Sign Up</button>
    <button id="loginBtn">Login</button>
    <button id="forgotBtn">Forgot Password?</button>

  </div>



  <!-- PHONE AUTH -->
  <div id="phoneAuth" style="display:none">

    <input id="phoneNumber" type="tel" placeholder="Phone (e.g., +91...)">

    <button id="sendOtpBtn">Send OTP</button>

    <input id="otpInput" type="text" placeholder="Enter OTP" style="display:none;">
    <button id="verifyOtpBtn" style="display:none;">Verify OTP</button>

    <select id="rolePhone">
      <option value="buyer">Buyer</option>
      <option value="seller">Seller</option>
    </select>

    <input id="whatsappPhone"
           type="tel"
           placeholder="WhatsApp Number"
           style="display:none;">
  </div>


  <p id="authMsg"></p>
  <div id="loadingAuth" class="loading">Loading...</div>

</section>



<!-- ================= NAME MODAL ================= -->
<div id="nameModal" class="modal">

  <div class="modal-content">

    <h3>Welcome! Please enter your name.</h3>

    <input id="userNameInput" type="text" placeholder="Your Name">

    <button id="submitNameBtn">Continue</button>

    <p id="nameMsg"></p>

  </div>

</div>



<!-- ================= DASHBOARD ================= -->
<section id="dashboard" style="display:none" class="dashboard">

  <h3>Welcome to Your Dashboard!</h3>

  <p id="userInfo">Loading...</p>



  <!-- STATS -->
  <div class="stats">

    <div class="stat">
      <h4>Total Listings</h4>
      <p id="totalListings">0</p>
    </div>

    <div class="stat">
      <h4>My Listings</h4>
      <p id="myListingsCount">0</p>
    </div>

    <div class="stat">
      <h4>Donations</h4>
      <p id="donationsCount">0</p>
    </div>

  </div>



  <!-- ACTION BUTTONS -->
  <div class="actions">
    <button id="addListingBtn">Add Listing</button>
    <button id="browseBtn">Browse</button>
    <button id="profileBtn">My Profile</button>
    <button id="donateBtnDash">Donate</button>
  </div>



  <!-- RECENT -->
  <div class="recent">
    <h4>Recent Activity</h4>
    <div id="recentActivity">No recent activity.</div>
  </div>



  <!-- ========== SELLER PANEL (STARTS HERE) ========== -->
  <div id="sellerPanel" style="display:none;margin-top:20px">

    <h4>Seller Panel</h4>


    <!-- BASIC LISTING FIELDS -->
     <select id="categoryInput">
      <option value="">Choose Category</option>
      <option value="art">Art</option>
      <option value="book">Book</option>
      <option value="sketch">Custom Sketch</option>
      <option value="notes">Handwritten Notes</option>
    </select>
    <input id="titleInput" placeholder="Title">

    <input id="priceInput" placeholder="Price">

    



    <!-- CLASS FIELD -->
    <select id="classInput">
<option value="">All Classes</option>
<option value="1">Class 1</option>
<option value="2">Class 2</option>
<option value="3">Class 3</option>
<option value="4">Class 4</option>
<option value="5">Class 5</option>
<option value="6">Class 6</option>
<option value="7">Class 7</option>
<option value="8">Class 8</option>
<option value="9">Class 9</option>
<option value="10">Class 10</option>
<option value="11">Class 11</option>
<option value="12">Class 12</option>
</select>

    <!-- SUBJECT FIELD (NOTES ONLY) -->
    <input id="subjectInput"
           placeholder="Subject (Notes only)"
           style="display:none;">


    <!-- BOARD FIELD (NOTES ONLY) -->
    <input id="boardInput"
           placeholder="Board (CBSE / State etc)"
           style="display:none;">


    <!-- IMAGE (book / art / sketch) -->
    <input id="imageInput" type="file" accept="image/*">


    <!-- PDF FOR NOTES -->
    <input id="pdfInput"
           type="file"
           accept="application/pdf"
           style="display:none;">



    <button id="addBtn">Upload Listing</button>

    <p id="uploadMsg"></p>
    <div id="loadingUpload" class="loading">Uploading...</div>


    <h5>Your Listings</h5>
    <div id="myListings"></div>

  </div>

</section>



<!-- ================= AVAILABLE LISTINGS ================= -->
<h3>Available Listings</h3>
<div style="margin-bottom:15px; display:flex; gap:10px; flex-wrap:wrap;">
  <select id="filterCategory">
    <option value="">All Categories</option>
    <option value="art">Art</option>
    <option value="book">Book</option>
    <option value="sketch">Custom Sketch</option>
    <option value="notes">Handwritten Notes</option>
  </select>

  <select id="filterClass">
    <option value="">All Classes</option>
    <option value="1">Class 1</option>
    <option value="2">Class 2</option>
    <option value="3">Class 3</option>
    <option value="4">Class 4</option>
    <option value="5">Class 5</option>
    <option value="6">Class 6</option>
    <option value="7">Class 7</option>
    <option value="8">Class 8</option>
    <option value="9">Class 9</option>
    <option value="10">Class 10</option>
    <option value="11">Class 11</option>
    <option value="12">Class 12</option>
  </select>

  <button id="applyFilterBtn">Apply Filter</button>
</div>

<div id="loader" class="loader"></div>

<div id="productContainer" class="grid"></div>



<!-- ================= DONATE SECTION ================= -->
<section id="donate">

  <h3>Donate</h3>

  <input id="donateName" placeholder="Your Name">

  <select id="donateType">
    <option value="book">Book</option>
    <option value="money">Money</option>
    <option value="other">Other</option>
  </select>

  <textarea id="donateMsg" placeholder="Message"></textarea>

  <button id="donateBtn">Donate via WhatsApp</button>

</section>



</div> <!-- container end -->



<footer>
  <p>Â© 2025 Student Art Hub â€” Built by Aayan</p>
</footer>





<!-- ================= SCRIPT ================= -->
<script type="module">

  /* --------------  FIREBASE IMPORTS -------------- */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";

  import {
    getAuth, createUserWithEmailAndPassword,
    signInWithEmailAndPassword, signOut,
    onAuthStateChanged, sendPasswordResetEmail,
    signInWithPhoneNumber, RecaptchaVerifier,
    sendEmailVerification, setPersistence,
    browserLocalPersistence
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

  import {
    getDatabase, ref, set, push,
    onValue, remove, update, get
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

  import {
    getStorage,
    ref as storageRef,
    uploadBytes,
    getDownloadURL
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-storage.js";



  /* --------------  FIREBASE CONFIG -------------- */
  const firebaseConfig = {
    apiKey: "AIzaSyBxD8SLW9z8ndgAJprcGolqivlNUZVYZxc",
    authDomain: "art-hub-77eb1.firebaseapp.com",
    databaseURL: "https://art-hub-77eb1-default-rtdb.firebaseio.com",
    projectId: "art-hub-77eb1",
    storageBucket: "art-hub-77eb1.appspot.com",
    messagingSenderId: "1097170910592",
    appId: "1:1097170910592:web:8590c10f6d0662d6881565"
  };


  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getDatabase(app);
  const storage = getStorage(app);


  /* GLOBAL */
  let currentUserRole = null;
let recaptchaVerifier = null;



  /* ================= UI EVENTS ================= */

  menuBtn.onclick = () => {
    dropdown.style.display =
      dropdown.style.display === "block" ? "none" : "block";
  };

categoryInput.onchange = () => {
  if (categoryInput.value === "notes") {
    subjectInput.style.display = "block";
    boardInput.style.display = "block";
    pdfInput.style.display = "block";
    imageInput.style.display = "none";
  } else {
    subjectInput.style.display = "none";
    boardInput.style.display = "none";
    pdfInput.style.display = "none";
    imageInput.style.display = "block";
  }
};

  /* -------- AUTH TABS -------- */

  emailTab.onclick = () => {
    emailTab.classList.add("active");
    phoneTab.classList.remove("active");
    emailAuth.style.display = "block";
    phoneAuth.style.display = "none";
  };

  phoneTab.onclick = () => {
    phoneTab.classList.add("active");
    emailTab.classList.remove("active");
    phoneAuth.style.display = "block";
    emailAuth.style.display = "none";
  };



  /* -------- PASSWORD STRENGTH -------- */

  password.oninput = () => {

    const len = password.value.length;

    const strength =
      len < 6 ? "Weak" :
      len < 10 ? "Medium" : "Strong";

    passwordStrength.textContent =
      "Password Strength: " + strength;

    passwordStrength.className =
      strength === "Strong" ? "strength strong" : "strength";
  };



  /* -------- ROLE HANDLING -------- */

  role.onchange = () => {
    whatsapp.style.display =
      role.value === "seller" ? "block" : "none";
  };

  rolePhone.onchange = () => {
    whatsappPhone.style.display =
      rolePhone.value === "seller" ? "block" : "none";
  };



  /* ===================================================
     SIGNUP
  =================================================== */
  signupBtn.onclick = async () => {

    loadingAuth.style.display = "block";

    if (!email.value || !password.value) {
      authMsg.textContent = "Email aur password daalo!";
      return loadingAuth.style.display = "none";
    }

    if (role.value === "seller" && !whatsapp.value) {
      authMsg.textContent = "Seller ke liye WhatsApp number daalo!";
      return loadingAuth.style.display = "none";
    }

    try {

      const userCredential =
        await createUserWithEmailAndPassword(auth, email.value, password.value);

      await sendEmailVerification(userCredential.user);

      await set(ref(db, "users/" + userCredential.user.uid), {
        role: role.value,
        whatsapp: whatsapp.value || null,
        authType: "email",
        name: null
      });

      authMsg.textContent = "Signup successful!";

      showNameModal(userCredential.user.uid);

    } catch (e) {
      authMsg.textContent = "Error: " + e.message;
    }

    loadingAuth.style.display = "none";
  };



  /* ===================================================
     LOGIN
  =================================================== */
  loginBtn.onclick = async () => {

    loadingAuth.style.display = "block";

    if (!email.value || !password.value) {
      authMsg.textContent = "Email aur password daalo!";
      return loadingAuth.style.display = "none";
    }

    try {

      await setPersistence(auth, browserLocalPersistence);

      const userCredential =
        await signInWithEmailAndPassword(auth, email.value, password.value);

if (!userCredential.user.emailVerified) {
  authMsg.textContent = "Please verify your email first!";
  await signOut(auth);
  loadingAuth.style.display = "none";
  return;
}

      authMsg.textContent = "Login successful!";

      showNameModal(userCredential.user.uid);

    } catch (e) {
      authMsg.textContent = "Error: " + e.message;
    }

    loadingAuth.style.display = "none";
  };



  /* RESET PASSWORD */
  forgotBtn.onclick = async () => {
    if (!email.value) return authMsg.textContent = "Email daalo!";

    await sendPasswordResetEmail(auth, email.value);
    authMsg.textContent = "Password reset email sent!";
  };



  /* ===================================================
     OTP LOGIN
  =================================================== */
  
sendOtpBtn.onclick = async () => {

  if (!phoneNumber.value)
    return authMsg.textContent = "Phone number daalo!";

  // âœ… FIX: recaptcha sirf ek baar banao
  if (!recaptchaVerifier) {
    recaptchaVerifier = new RecaptchaVerifier(auth, "sendOtpBtn", {
      size: "invisible"
    });
  }

  try {
    const confirmationResult =
      await signInWithPhoneNumber(auth, phoneNumber.value, recaptchaVerifier);

    window.confirmationResult = confirmationResult;

    otpInput.style.display = "block";
    verifyOtpBtn.style.display = "block";
    sendOtpBtn.style.display = "none";

    authMsg.textContent = "OTP bhej diya ðŸ“²";

  } catch (error) {
    authMsg.textContent = error.message;
  }
};



  verifyOtpBtn.onclick = async () => {

    if (!otpInput.value)
      return authMsg.textContent = "OTP daalo!";

    try {

      const result =
        await window.confirmationResult.confirm(otpInput.value);

    await update(ref(db, "users/" + result.user.uid), {
  role: rolePhone.value,
  whatsapp: whatsappPhone.value || null,
  authType: "phone"
});
// name ko overwrite mat karo


      authMsg.textContent = "Phone login successful!";
      showNameModal(result.user.uid);

    } catch {
      authMsg.textContent = "Invalid OTP!";
    }
  };



  /* ===================================================
     NAME MODAL
  =================================================== */
  function showNameModal(uid) {

    nameModal.style.display = "flex";

    submitNameBtn.onclick = async () => {

      if (!userNameInput.value.trim())
        return nameMsg.textContent = "Name daalo!";

      await update(
        ref(db, "users/" + uid),
        { name: userNameInput.value.trim() }
      );

      nameModal.style.display = "none";
      loadDashboard(uid);
    };
  }



  /* ===================================================
     DASHBOARD LOAD
  =================================================== */
  function loadDashboard(uid) {

    get(ref(db, "users/" + uid)).then(snap => {

     const user = snap.val();

// âœ… FIX: agar naam pehle se hai to modal skip
if (user.name) {
  currentUserRole = user.role;

  userInfo.textContent = `Hello, ${user.name}! Role: ${user.role}`;

  if (user.role === "seller") {
    sellerPanel.style.display = "block";
    loadMyListings(uid);
  }

  dashboard.style.display = "block";
  authSection.style.display = "none";
  userMenu.style.display = "block";

  loadStats(uid);
  loadRecentActivity(uid);
  return;
}

currentUserRole = user.role;


      userInfo.textContent =
        `Hello, ${user.name}! Role: ${user.role}`;

      if (user.role === "seller") {
        sellerPanel.style.display = "block";
        loadMyListings(uid);
      }

      dashboard.style.display = "block";
      authSection.style.display = "none";
      userMenu.style.display = "block";

      loadStats(uid);
      loadRecentActivity(uid);
    });
  }



  /* -------- STATS -------- */
  function loadStats(uid) {

    onValue(ref(db, "listings"), snap => {

  if (!snap.exists()) {
    productContainer.innerHTML = "<p>No listings yet ðŸš€</p>";
    return;
  }

  const listings = snap.val() || {};


      totalListings.textContent = Object.keys(listings).length;

      myListingsCount.textContent =
        Object.values(listings).filter(l => l.sellerId === uid).length;

    });

    onValue(ref(db, "donations"), snap => {

      const donations = snap.val() || {};

      donationsCount.textContent =
        Object.values(donations).filter(d => d.userId === uid).length;

    });

  }



  /* -------- RECENT ACTIVITY -------- */
  function loadRecentActivity(uid) {

    onValue(ref(db, "listings"), snap => {

      const listings = snap.val() || {};

      const my = Object.values(listings)
        .filter(l => l.sellerId === uid);

      recentActivity.innerHTML =
        my.length
          ? my.slice(-3).map(l => `<p>${l.title} - â‚¹${l.price}</p>`).join("")
          : "No recent activity.";
    });
  }



  /* ===================================================
     MY LISTINGS PANEL
  =================================================== */
  function loadMyListings(uid) {

    onValue(ref(db, "listings"), snap => {

      const listings = snap.val() || {};

      const my = Object.values(listings)
        .filter(l => l.sellerId === uid);

      myListings.innerHTML = my.map(l => `

          <div class="card">
            <img src="${l.imageUrl || 'https://via.placeholder.com/150'}">
            <h4>${l.title}</h4>
            <p>â‚¹${l.price}</p>
            <button onclick="deleteListing('${l.id}')">Delete</button>
          </div>

      `).join("");
    });
  }

  window.deleteListing = (id) => {
  if (confirm("Delete this listing?")) {
    remove(ref(db, "listings/" + id));
  }
};




  /* ===================================================
     UPLOAD LISTING
  =================================================== */
  addBtn.onclick = async () => {

    if (currentUserRole !== "seller")
      return alert("Only sellers can upload listings.");

    if (!titleInput.value || !priceInput.value || !categoryInput.value)
      return uploadMsg.textContent = "Saare fields fill karo!";



    /* VALIDATION FOR CLASS + NOTES */
    if ((categoryInput.value === "book" || categoryInput.value === "notes") &&
        !classInput.value)
      return uploadMsg.textContent = "Class required for Book/Notes!";

    if (categoryInput.value === "notes") {

      if (!subjectInput.value || !boardInput.value)
        return uploadMsg.textContent = "Subject + Board required for Notes!";

      if (!pdfInput.files[0])
        return uploadMsg.textContent = "Upload PDF for notes!";
    }



    loadingUpload.style.display = "block";

    const uid = auth.currentUser.uid;

    let imageUrl = null;
    let pdfUrl   = null;



    /* UPLOAD IMAGE IF PRESENT */
    const file = imageInput.files[0];

    if (file) {
      const ref1 = storageRef(storage, "listings/" + uid + "/" + file.name);
      await uploadBytes(ref1, file);
      imageUrl = await getDownloadURL(ref1);
    }


    /* UPLOAD PDF IF NOTES */
    if (pdfInput.files[0]) {
      const ref2 = storageRef(storage, "notes/" + uid + "/" + pdfInput.files[0].name);
      await uploadBytes(ref2, pdfInput.files[0]);
      pdfUrl = await getDownloadURL(ref2);
    }


    const newRef = push(ref(db, "listings"));

    await set(newRef, {

      id: newRef.key,
      sellerId: uid,

      title: titleInput.value,
      price: priceInput.value,

      category: categoryInput.value,

      class: classInput.value || null,
      subject: subjectInput.value || null,
      board: boardInput.value || null,

      imageUrl,
      pdfUrl,

      timestamp: Date.now()

    });


    uploadMsg.textContent = "Listing added!";
    loadingUpload.style.display = "none";

    titleInput.value =
    priceInput.value =
    classInput.value =
    subjectInput.value =
    boardInput.value = "";

    imageInput.value = "";
    pdfInput.value = "";
    categoryInput.value = "";
categoryInput.dispatchEvent(new Event("change"));

  };



  /* ===================================================
     LOGOUT
  =================================================== */
  logoutBtn.onclick = async () => {

    await signOut(auth);

    dashboard.style.display = "none";
    authSection.style.display = "block";
    userMenu.style.display = "none";

    authMsg.textContent = "Logged out!";
  };



  /* ===================================================
     AUTH STATE WATCHER
  =================================================== */
  onAuthStateChanged(auth, (user) => {

    if (user) loadDashboard(user.uid);
    else {
      dashboard.style.display = "none";
      authSection.style.display = "block";
      userMenu.style.display = "none";
    }
  });



  /* ===================================================
     LOAD LISTINGS (HOME)
  =================================================== */
  function loadListings() {

document.getElementById("loader").style.display = "block";

    onValue(ref(db, "listings"), snap => {

      const listings = snap.val() || {};
document.getElementById("loader").style.display = "none";

      productContainer.innerHTML =
        Object.values(listings).map(l => `

          <div class="card">
            <img src="${l.imageUrl || 'https://via.placeholder.com/150'}">

            <h4>${l.title}</h4>

            <p>â‚¹${l.price}</p>

            ${l.class ? `<p>Class: ${l.class}</p>` : ""}
            ${l.subject ? `<p>Subject: ${l.subject}</p>` : ""}
            ${l.board ? `<p>Board: ${l.board}</p>` : ""}

            ${l.pdfUrl ? `<a href="${l.pdfUrl}" target="_blank">View Notes (PDF)</a>` : ""}

            <button onclick="contactSeller('${l.sellerId}')">
                Contact Seller
            </button>
          </div>

        `).join("");
    });
  }



  /* CONTACT SELLER */
  window.contactSeller = (id) => {

    get(ref(db, "users/" + id)).then(snap => {

      const seller = snap.val();

      seller?.whatsapp
        ? window.open(`https://wa.me/${seller.whatsapp}?text=Hi, interested!`)
        : alert("Seller WhatsApp not available.");
    });
  };



  /* SEARCH */
  searchBtn.onclick = () => {

    const q = searchBar.value.toLowerCase();

    onValue(ref(db, "listings"), snap => {

      const listings = snap.val() || {};

      const filtered = Object.values(listings).filter(l =>
        (l.title || "").toLowerCase().includes(q) ||
        (l.category || "").toLowerCase().includes(q) ||
        (l.class || "").toLowerCase().includes(q) ||
        (l.subject || "").toLowerCase().includes(q)
      );

      productContainer.innerHTML =
        filtered.map(l => `

          <div class="card">
            <img src="${l.imageUrl || 'https://via.placeholder.com/150'}">

            <h4>${l.title}</h4>
            <p>â‚¹${l.price}</p>

            ${l.class ? `<p>Class: ${l.class}</p>` : ""}
            ${l.subject ? `<p>Subject: ${l.subject}</p>` : ""}

            ${l.pdfUrl ? `<a href="${l.pdfUrl}" target="_blank">View PDF</a>` : ""}

            <button onclick="contactSeller('${l.sellerId}')">
              Contact Seller
            </button>
          </div>

        `).join("");
    });
  };



  /* DONATION */
  donateBtn.onclick = () => {

    if (!donateName.value)
      return alert("Name daalo!");

    const msg =
      `Hi, donate: ${donateType.value}, Name: ${donateName.value}, Message: ${donateMsg.value}`;

    window.open(
      `https://wa.me/919878455467?text=${encodeURIComponent(msg)}`,
      "_blank"
    );

    const uid = auth.currentUser?.uid;

    if (uid)
      push(ref(db, "donations"), {
        userId: uid,
        type: donateType.value,
        message: donateMsg.value,
        timestamp: Date.now()
      });

  };


  /* BUTTON ACTIONS */
 addListingBtn.onclick = () => {
  if (currentUserRole !== "seller")
    return alert("Only sellers can upload!");

  sellerPanel.style.display =
    sellerPanel.style.display === "none" ? "block" : "none";

  // ðŸ‘‡ smooth scroll to seller panel
  sellerPanel.scrollIntoView({ behavior: "smooth" });
};

browseBtn.onclick = loadListings;
profileBtn.onclick = () => window.location.href = "profile.html";
donateBtnDash.onclick = () => window.location.href = "#donate";

// ===== FILTER LISTINGS =====
applyFilterBtn.onclick = () => {

  const selectedCategory = filterCategory.value;
  const selectedClass = filterClass.value;

  document.getElementById("loader").style.display = "block";

get(ref(db, "listings")).then(snap => {


    const listings = snap.val() || {};
    document.getElementById("loader").style.display = "none";

    const filtered = Object.values(listings).filter(l => {
      const categoryMatch =
        !selectedCategory || l.category === selectedCategory;

      const classMatch =
        !selectedClass || String(l.class) === selectedClass;

      return categoryMatch && classMatch;
    });

    if (!filtered.length) {
      productContainer.innerHTML = "<p>No matching listings ðŸ˜•</p>";
      return;
    }

    productContainer.innerHTML = filtered.map(l => `
      <div class="card">
        <img src="${l.imageUrl || 'https://via.placeholder.com/150'}">
        <h4>${l.title}</h4>
        <p>â‚¹${l.price}</p>
        ${l.class ? `<p>Class: ${l.class}</p>` : ""}
        <button onclick="contactSeller('${l.sellerId}')">
          Contact Seller
        </button>
      </div>
    `).join("");
  });
};


  /* START */
  loadListings();

</script>

</body>
</html>
