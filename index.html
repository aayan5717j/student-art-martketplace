<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Student Art Hub: Buy, sell, and exchange student-made art, books, sketches, and notes at affordable prices." />
  <meta name="keywords" content="student art, marketplace, buy sell art, custom sketches, handwritten notes, book exchange" />
  <title>Student Art Hub</title>

<style>
body{margin:0;font-family:Arial;background:#f2f2f2}
header{background:#1e3a8a;color:#fff;padding:15px}
nav a{color:#fff;margin:0 10px;text-decoration:none;font-weight:bold}
.container{padding:20px}
.hero{background:#fff;padding:30px;border-radius:10px}
input,select,button,textarea{padding:8px;margin:5px;width:100%;max-width:320px}
button{cursor:pointer;background:#1e3a8a;color:#fff;border:none;border-radius:5px}
.grid{display:flex;gap:15px;flex-wrap:wrap}
.card{background:#fff;padding:15px;border-radius:10px;width:220px}
footer{background:#111;color:#fff;text-align:center;padding:15px;margin-top:40px}
@media (max-width: 600px) { .grid { flex-direction: column; } .card { width: 100%; } } /* Mobile responsive */
</style>
</head>

<body>

<header>
  <h2>Student Art Hub</h2>
  <nav>
    <a href="index.html">Home</a>
    <a href="art.html">Art Showcase</a>
    <a href="books.html">Book Exchange</a>
    <a href="sketches.html">Custom Sketches</a>
    <a href="notes.html">Handwritten Notes</a>
    <a href="donations.html">Donations</a>
  </nav>
</header>

<div class="container">

<!-- HERO -->
<section class="hero">
  <h2>Buy • Sell • Exchange — Student-made</h2>
  <p>Artworks, books, sketches & handwritten notes</p>
  <input id="searchBar" placeholder="Search..." />
  <button id="searchBtn">Search</button>
</section>

<!-- AUTH -->
<section id="authSection">
  <h3>Login / Signup</h3>
  <input id="email" type="email" placeholder="Email">
  <input id="password" type="password" placeholder="Password">
  <select id="role">
    <option value="buyer">Buyer</option>
    <option value="seller">Seller</option>
  </select>
  <input id="whatsapp" type="tel" placeholder="WhatsApp Number (e.g., 918882529632)" style="display:none;"> <!-- Seller ke liye dikhayenge -->
  <br>
  <button id="signupBtn">Sign Up</button>
  <button id="loginBtn">Login</button>
  <button id="forgotBtn">Forgot Password?</button> <!-- Naya button add kiya -->
  <p id="authMsg"></p>
</section>

<!-- DASHBOARD -->
<section id="dashboard" style="display:none">
  <h3>User Dashboard</h3>
  <p id="userInfo"></p>
  <button id="logoutBtn">Logout</button>

  <div id="sellerPanel" style="display:none">
    <h4>Add Listing</h4>
    <input id="titleInput" placeholder="Title">
    <input id="priceInput" placeholder="Price">
    <input id="categoryInput" placeholder="Category">
    <button id="addBtn">Upload</button>

    <h4>Your Listings</h4>
    <div id="myListings"></div>
  </div>
</section>

<!-- PRODUCTS -->
<h3>Available Listings</h3>
<div id="productContainer" class="grid"></div>

<!-- DONATION -->
<section>
  <h3>Donate</h3>
  <input id="donateName" placeholder="Your Name">
  <select id="donateType">
    <option value="book">Book</option>
    <option value="money">Money</option>
    <option value="other">Other</option>
  </select>
  <textarea id="donateMsg" placeholder="Message"></textarea>
  <button id="donateBtn">Donate via WhatsApp</button>
</section>

</div>

<footer>
<p>© 2025 Student Art Hub — Built by Aryan</p>
</footer>

<!-- FIREBASE -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import {
  getAuth,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  signOut,
  onAuthStateChanged,
  sendPasswordResetEmail  // Naya import add kiya
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
import {
  getDatabase,
  ref,
  set,
  push,
  onValue,
  remove,
  update,
  get
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBxD8SLW9z8ndgAJprcGolqivlNUZVYZxc",
  authDomain: "art-hub-77eb1.firebaseapp.com",
  databaseURL: "https://art-hub-77eb1-default-rtdb.firebaseio.com",
  projectId: "art-hub-77eb1",
  storageBucket: "art-hub-77eb1.appspot.com",
  messagingSenderId: "1097170910592",
  appId: "1:1097170910592:web:8590c10f6d0662d6881565"
};

// IMPORTANT: Firebase Console mein jaake Realtime Database Rules set karo taaki sirf authenticated users write kar sake. Example rule: { "rules": { ".read": true, ".write": "auth != null" } }

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

// Role change hone pe WhatsApp field show/hide karo
role.onchange = () => {
  whatsapp.style.display = (role.value === "seller") ? "block" : "none";
};

signupBtn.onclick = async ()=>{
  if (!email.value || !password.value) {
    authMsg.textContent = "Email aur password daalo!";
    return;
  }
  if (role.value === "seller" && !whatsapp.value) {
    authMsg.textContent = "Seller ke liye WhatsApp number daalo!";
    return;
  }
  try {
    const userCredential = await createUserWithEmailAndPassword(auth, email.value, password.value);
    await set(ref(db, 'users/' + userCredential.user.uid), { 
      role: role.value, 
      whatsapp: whatsapp.value || null // Buyer ke liye null
    });
    authMsg.textContent = "Signup successful!";
  } catch (error) {
    authMsg.textContent = "Error: " + error.message;
  }
};

loginBtn.onclick = async ()=>{
  if (!email.value || !password.value) {
    authMsg.textContent = "Email aur password daalo!";
    return;
  }
  try {
    await signInWithEmailAndPassword(auth, email.value, password.value);
    authMsg.textContent = "Login successful!";
  } catch (error) {
    authMsg.textContent = "Error: " + error.message;
  }
};

// Forgot Password button ka function
forgotBtn.onclick = async () => {
  if (!email.value) {
    authMsg.textContent = "Please enter your email address.";
    return;
  }

  try {
    await sendPasswordResetEmail(auth, email.value, {
      url: "https://aayan5717j.github.io/student-art-marketplace/index.html",  // Fixed: Corrected repo name and page (assuming index.html is main)
      handleCodeInApp: false
    });

    authMsg.textContent =
      "Password reset email has been sent. Please check your inbox and spam folder.";
  } catch (error) {
    authMsg.textContent = "Error: " + error.message;
  }
};

logoutBtn.onclick = () => signOut(auth);

onAuthStateChanged(auth, async (user) => {  // Fixed: Proper async callback
  if (user) {
    authSection.style.display = "none";
    dashboard.style.display = "block";
    userInfo.textContent = "Logged in as " + user.email;

    // Role fetch karo database se (moved inside if block)
    const userRef = ref(db, 'users/' + user.uid);
    onValue(userRef, (snapshot) => {
      const data = snapshot.val();
      if (data && data.role === "seller") {
        sellerPanel.style.display = "block";
      }
    });

    loadAllListings();
    loadMyListings(user.uid);
  } else {
    authSection.style.display = "block";
    dashboard.style.display = "none";
  }
});

addBtn.onclick = async ()=>{
  if (!titleInput.value || !priceInput.value || !categoryInput.value) {
    authMsg.textContent = "Saare fields fill karo!";
    return;
  }
  try {
    const listingRef = push(ref(db,"listings"));
    await set(listingRef,{
      title:titleInput.value,
      price:priceInput.value,
      category:categoryInput.value,
      seller:auth.currentUser.uid
    });
    authMsg.textContent = "Listing added!";
    titleInput.value = ""; priceInput.value = ""; categoryInput.value = ""; // Clear fields
  } catch (error) {
    authMsg.textContent = "Error adding listing: " + error.message;
  }
};

function loadAllListings(filter=""){
  onValue(ref(db,"listings"),snap=>{
    productContainer.innerHTML="";
    snap.forEach(c=>{
      const d=c.val();
      if(filter && !d.title.toLowerCase().includes(filter.toLowerCase())) return;
      const div=document.createElement("div");
      div.className="card";
      div.innerHTML=`<b>${d.title}</b><br>₹${d.price}<br>${d.category}`;
      // Buy button add kiya - logged-in users click kar sakte hain
      if (auth.currentUser) {
        const buyBtn = document.createElement("button");
        buyBtn.textContent = "Buy";
        buyBtn.onclick = () => buyItem(d.title, d.price, d.seller);
        div.appendChild(buyBtn);
      }
      productContainer.appendChild(div);
    });
  });
}

function loadMyListings(uid){
  onValue(ref(db,"listings"),snap=>{
    myListings.innerHTML="";
    snap.forEach(c=>{
      const d=c.val();
      if(d.seller===uid){
        const div=document.createElement("div");
        div.innerHTML=`${d.title} - ₹${d.price}`;
        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "Delete";
        deleteBtn.onclick = () => deleteItem(c.key);
        div.appendChild(deleteBtn);
        myListings.appendChild(div);
      }
    });
  });
}

function deleteItem(id){
  remove(ref(db,"listings/"+id));
}

async function buyItem(title, price, sellerUid) {
  // Seller ka WhatsApp number fetch karo database se
  const sellerRef = ref(db, 'users/' + sellerUid);
  const snapshot = await get(sellerRef);
  const sellerData = snapshot.val();
  if (sellerData && sellerData.whatsapp) {
    const msg = `Hi, I want to buy: ${title} for ₹${price}. Can we discuss?`;
    window.open(`https://wa.me/${sellerData.whatsapp}?text=${encodeURIComponent(msg)}`, "_blank");
  } else {
    alert("Seller ka WhatsApp number nahi mila. Contact admin!");
  }
}

searchBtn.onclick=()=>{
  loadAllListings(searchBar.value);
};

donateBtn.onclick=()=>{
  if (!donateName.value) {
    alert("Name daalo!");
    return;
  }
  const msg=`Donation\nName:${donateName.value}\nType:${donateType.value}\nMessage:${donateMsg.value}`;
  window.open(`https://wa.me/918882529632?text=${encodeURIComponent(msg)}`,"_blank");
};

loadAllListings();
</script>

</body>
</html>
